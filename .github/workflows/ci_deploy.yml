name: CI/deploy

on:
  pull_request:
  push:
    branches: ['deploy', 'master']


jobs:

  tests:
    env:
        PMG_API_KEY: ${{ secrets.PMG_API_KEY }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: [3.7, 3.8, 3.9]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Setup and install standard requirements
      shell: bash -l {0}
      run: |
        set -vxeuo pipefail
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install .
        python3 -m pip list
    - name: Install dev requirements
      shell: bash -l {0}
      run: |
        set -vxeuo pipefail
        python3 -m pip install '.[dev]'
        python3 -m pip list
    - name: Run tests
      shell: bash -l {0}
      run: |
        set -vxeuo pipefail
        pytest -v --cov --cov-report xml lightshow/_tests

  black:
    name: runner / black formatter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: rickstaa/action-black@v1
        with:
          black_args: "lightshow/ --check"
          fail_on_error: "true"

  flake8_py3:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install flake8
        run: pip install flake8
      - name: Run flake8
        uses: suo/flake8-github-action@releases/v1
        with:
          checkName: 'flake8_py3'   # NOTE: this needs to be the same as the job name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check_semantic_version_placeholder:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Check lines exist
      shell: bash -l {0}
      run: |
        grep -x "__version__ = ...  # semantic-version-placeholder" lightshow/__init__.py

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Setup and install standard requirements
      shell: bash -l {0}
      run: |
        set -vxeuo pipefail
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install .
        python3 -m pip list
    - name: Install dev requirements
      shell: bash -l {0}
      run: |
        set -vxeuo pipefail
        python3 -m pip install '.[dev]'
        python3 -m pip list
    - name: Install sphinx dependencies
      run: |
        pip install sphinx sphinx_rtd_theme
    - name: Sphinx build
      run: |
        make -C docs/ html

    #https://coderefinery.github.io/documentation/gh_workflow/
    # - name: Deploy
    #   uses: peaceiris/actions-gh-pages@v3
    #   if: ${{ github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags') && github.ref == 'refs/heads/deploy'}}
    #   with:
    #     publish_branch: gh-pages
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: docs/build
    #     force_orphan: true

  publish:
    name: Publish to PyPi
    needs: [tests, black, flake8_py3, check_semantic_version_placeholder, docs]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags') && github.ref == 'refs/heads/deploy'}}
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Build and publish
      run: | # CHANGE THIS TO USE build.sh
        bash build.sh install-dev  
      # env:
      #   FLIT_USERNAME: __token__
      #   FLIT_PASSWORD: ${{ secrets.PYPI_KEY }}
